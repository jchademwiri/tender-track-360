# Database Schema

## Overview

This document outlines the complete database schema for Tender Track 360, implemented with PostgreSQL and accessed via Drizzle ORM. The schema supports the full tender management lifecycle with proper relationships, constraints, and performance optimizations.

## Current Implementation Status

âœ… **Implemented**: Core tables (users, tenders, documents, tasks, tender-extensions)  
ğŸ”„ **In Progress**: Activity logs, notifications, custom fields  
ğŸ“‹ **Planned**: Advanced analytics tables, reporting views

## Entity Relationship Diagram

_Note: Create an ERD using a database modeling tool and include the image or link here._

## Tables

### users

Stores user account information and is managed by Supabase Auth with additional custom fields.

| Column        | Type         | Constraints             | Description                               |
| ------------- | ------------ | ----------------------- | ----------------------------------------- |
| id            | uuid         | PRIMARY KEY             | User ID (generated by Supabase Auth)      |
| email         | varchar(255) | NOT NULL, UNIQUE        | User's email address                      |
| full_name     | varchar(255) |                         | User's full name                          |
| role          | varchar(50)  | NOT NULL                | User role (admin, tender_officer, viewer) |
| department    | varchar(100) |                         | User's department                         |
| is_active     | boolean      | NOT NULL, DEFAULT true  | Whether the user account is active        |
| last_login_at | timestamp    |                         | Timestamp of last login                   |
| created_at    | timestamp    | NOT NULL, DEFAULT now() | When the record was created               |
| updated_at    | timestamp    | NOT NULL, DEFAULT now() | When the record was last updated          |

### tenders

Stores the main tender information.

| Column              | Type          | Constraints             | Description                                                            |
| ------------------- | ------------- | ----------------------- | ---------------------------------------------------------------------- |
| id                  | serial        | PRIMARY KEY             | Unique tender ID                                                       |
| reference_number    | varchar(100)  | NOT NULL                | Official tender reference number                                       |
| title               | varchar(255)  | NOT NULL                | Tender title                                                           |
| description         | text          |                         | Detailed tender description                                            |
| department          | varchar(100)  |                         | Government department issuing the tender                               |
| value               | decimal(15,2) |                         | Estimated tender value                                                 |
| status              | varchar(50)   | NOT NULL                | Current status (draft, submitted, under_evaluation, awarded, rejected) |
| publication_date    | date          |                         | When the tender was published                                          |
| submission_deadline | timestamp     |                         | Deadline for tender submission                                         |
| evaluation_date     | date          |                         | Expected evaluation date                                               |
| award_date          | date          |                         | Date when award decision is expected                                   |
| outcome             | varchar(50)   |                         | Final outcome (awarded, rejected, canceled)                            |
| outcome_notes       | text          |                         | Notes about the outcome                                                |
| created_by          | uuid          | FOREIGN KEY             | Reference to user who created the record                               |
| assigned_to         | uuid          | FOREIGN KEY             | Reference to user responsible for the tender                           |
| created_at          | timestamp     | NOT NULL, DEFAULT now() | When the record was created                                            |
| updated_at          | timestamp     | NOT NULL, DEFAULT now() | When the record was last updated                                       |

### documents

Stores metadata about uploaded documents.

| Column      | Type         | Constraints             | Description                                                      |
| ----------- | ------------ | ----------------------- | ---------------------------------------------------------------- |
| id          | serial       | PRIMARY KEY             | Unique document ID                                               |
| tender_id   | integer      | FOREIGN KEY, NOT NULL   | Reference to associated tender                                   |
| name        | varchar(255) | NOT NULL                | Document name                                                    |
| type        | varchar(100) | NOT NULL                | Document type (application_form, supporting_doc, feedback, etc.) |
| file_path   | varchar(255) | NOT NULL                | Path to file in storage                                          |
| file_size   | integer      | NOT NULL                | Size of file in bytes                                            |
| mime_type   | varchar(100) | NOT NULL                | MIME type of the file                                            |
| version     | integer      | NOT NULL, DEFAULT 1     | Document version number                                          |
| uploaded_by | uuid         | FOREIGN KEY, NOT NULL   | Reference to user who uploaded the document                      |
| uploaded_at | timestamp    | NOT NULL, DEFAULT now() | When the document was uploaded                                   |

### notes

Stores notes and comments related to tenders.

| Column     | Type      | Constraints             | Description                            |
| ---------- | --------- | ----------------------- | -------------------------------------- |
| id         | serial    | PRIMARY KEY             | Unique note ID                         |
| tender_id  | integer   | FOREIGN KEY, NOT NULL   | Reference to associated tender         |
| content    | text      | NOT NULL                | Note content                           |
| created_by | uuid      | FOREIGN KEY, NOT NULL   | Reference to user who created the note |
| created_at | timestamp | NOT NULL, DEFAULT now() | When the note was created              |

### tasks

Stores tasks related to tenders.

| Column      | Type         | Constraints                 | Description                                   |
| ----------- | ------------ | --------------------------- | --------------------------------------------- |
| id          | serial       | PRIMARY KEY                 | Unique task ID                                |
| tender_id   | integer      | FOREIGN KEY, NOT NULL       | Reference to associated tender                |
| title       | varchar(255) | NOT NULL                    | Task title                                    |
| description | text         |                             | Detailed task description                     |
| due_date    | timestamp    |                             | Task due date                                 |
| status      | varchar(50)  | NOT NULL, DEFAULT 'pending' | Task status (pending, in_progress, completed) |
| assigned_to | uuid         | FOREIGN KEY                 | Reference to user assigned to the task        |
| created_by  | uuid         | FOREIGN KEY, NOT NULL       | Reference to user who created the task        |
| created_at  | timestamp    | NOT NULL, DEFAULT now()     | When the task was created                     |
| updated_at  | timestamp    | NOT NULL, DEFAULT now()     | When the task was last updated                |

### notifications

Stores system notifications.

| Column     | Type         | Constraints             | Description                                                      |
| ---------- | ------------ | ----------------------- | ---------------------------------------------------------------- |
| id         | serial       | PRIMARY KEY             | Unique notification ID                                           |
| user_id    | uuid         | FOREIGN KEY, NOT NULL   | User to notify                                                   |
| tender_id  | integer      | FOREIGN KEY             | Associated tender (if applicable)                                |
| title      | varchar(255) | NOT NULL                | Notification title                                               |
| message    | text         | NOT NULL                | Notification message                                             |
| type       | varchar(50)  | NOT NULL                | Type of notification (deadline, status_change, assignment, etc.) |
| is_read    | boolean      | NOT NULL, DEFAULT false | Whether the notification has been read                           |
| created_at | timestamp    | NOT NULL, DEFAULT now() | When the notification was created                                |

### tender_history

Tracks changes to tenders for audit purposes.

| Column     | Type         | Constraints             | Description                           |
| ---------- | ------------ | ----------------------- | ------------------------------------- |
| id         | serial       | PRIMARY KEY             | Unique history entry ID               |
| tender_id  | integer      | FOREIGN KEY, NOT NULL   | Reference to associated tender        |
| field      | varchar(100) | NOT NULL                | Field that was changed                |
| old_value  | text         |                         | Previous value                        |
| new_value  | text         |                         | New value                             |
| changed_by | uuid         | FOREIGN KEY, NOT NULL   | Reference to user who made the change |
| changed_at | timestamp    | NOT NULL, DEFAULT now() | When the change was made              |

## Indexes

| Table         | Index Name                      | Columns             | Type  | Purpose                                |
| ------------- | ------------------------------- | ------------------- | ----- | -------------------------------------- |
| tenders       | idx_tenders_status              | status              | BTREE | Optimize filtering by status           |
| tenders       | idx_tenders_submission_deadline | submission_deadline | BTREE | Optimize deadline queries              |
| documents     | idx_documents_tender_id         | tender_id           | BTREE | Optimize document lookup by tender     |
| notes         | idx_notes_tender_id             | tender_id           | BTREE | Optimize note lookup by tender         |
| tasks         | idx_tasks_status                | status              | BTREE | Optimize filtering by task status      |
| tasks         | idx_tasks_assigned_to           | assigned_to         | BTREE | Optimize finding tasks by assignee     |
| notifications | idx_notifications_user_id       | user_id             | BTREE | Optimize finding notifications by user |
| notifications | idx_notifications_is_read       | is_read             | BTREE | Optimize filtering by read status      |

## Relationships

### One-to-Many

- User to Tenders (created_by)
- User to Tenders (assigned_to)
- User to Documents (uploaded_by)
- User to Notes (created_by)
- User to Tasks (created_by)
- User to Tasks (assigned_to)
- User to Notifications (user_id)
- Tender to Documents
- Tender to Notes
- Tender to Tasks
- Tender to TenderHistory

## Drizzle Schema Definition

```typescript
// Example of how the schema will be defined in Drizzle

// src/db/schema.ts
import { relations } from 'drizzle-orm';
import {
  pgTable,
  uuid,
  varchar,
  timestamp,
  text,
  boolean,
  date,
  integer,
  pgEnum,
  numeric,
} from 'drizzle-orm/pg-core';

// Enums
export const userRoleEnum = pgEnum('user_role', [
  'admin',
  'tender_officer',
  'viewer',
]);
export const tenderStatusEnum = pgEnum('tender_status', [
  'draft',
  'published',
  'in_progress',
  'submitted',
  'evaluation',
  'awarded',
  'rejected',
  'cancelled',
]);
export const documentCategoryEnum = pgEnum('document_category', [
  'tender_notice',
  'technical_specifications',
  'financial_proposal',
  'legal_documents',
  'correspondence',
  'other',
]);
export const notificationTypeEnum = pgEnum('notification_type', [
  'deadline',
  'status_change',
  'task_assignment',
  'document_update',
  'custom',
]);
export const clientTypeEnum = pgEnum('client_type', [
  'government',
  'parastatal',
  'private',
  'ngo',
  'international',
  'other',
]);

// Users Table (Extended from Supabase Auth)
export const users = pgTable('users', {
  id: uuid('id').primaryKey().notNull(), // Matches Supabase Auth user id
  email: varchar('email', { length: 255 }).notNull().unique(),
  fullName: varchar('full_name', { length: 255 }),
  role: userRoleEnum('role').notNull().default('viewer'),
  department: varchar('department', { length: 100 }),
  isActive: boolean('is_active').notNull().default(true),
  lastLogin: timestamp('last_login', { withTimezone: true }),
  profileImageUrl: varchar('profile_image_url', { length: 255 }),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Clients Table (Tender Issuers)
export const clients = pgTable('clients', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: varchar('name', { length: 255 }).notNull(),
  type: clientTypeEnum('type').notNull(),
  contactPerson: varchar('contact_person', { length: 255 }),
  contactEmail: varchar('contact_email', { length: 255 }),
  contactPhone: varchar('contact_phone', { length: 50 }),
  address: text('address'),
  website: varchar('website', { length: 255 }),
  description: text('description'),
  isActive: boolean('is_active').notNull().default(true),
  createdById: uuid('created_by_id').references(() => users.id),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Tenders Table
export const tenders = pgTable('tenders', {
  id: uuid('id').primaryKey().defaultRandom(),
  referenceNumber: varchar('reference_number', { length: 100 }).notNull(),
  title: varchar('title', { length: 255 }).notNull(),
  description: text('description'),
  clientId: uuid('client_id')
    .references(() => clients.id)
    .notNull(),
  status: tenderStatusEnum('status').notNull().default('draft'),
  publicationDate: date('publication_date'),
  submissionDeadline: timestamp('submission_deadline', { withTimezone: true }),
  evaluationDate: date('evaluation_date'),
  awardDate: date('award_date'),
  estimatedValue: numeric('estimated_value', { precision: 15, scale: 2 }),
  actualValue: numeric('actual_value', { precision: 15, scale: 2 }),
  isSuccessful: boolean('is_successful'),
  department: varchar('department', { length: 100 }),
  notes: text('notes'),
  createdById: uuid('created_by_id')
    .references(() => users.id)
    .notNull(),
  updatedById: uuid('updated_by_id')
    .references(() => users.id)
    .notNull(),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Documents Table
export const documents = pgTable('documents', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenderId: uuid('tender_id')
    .references(() => tenders.id)
    .notNull(),
  category: documentCategoryEnum('category').notNull(),
  title: varchar('title', { length: 255 }).notNull(),
  fileName: varchar('file_name', { length: 255 }).notNull(),
  fileSize: integer('file_size').notNull(), // Size in bytes
  mimeType: varchar('mime_type', { length: 100 }).notNull(),
  storageUrl: varchar('storage_url', { length: 255 }).notNull(),
  version: integer('version').notNull().default(1),
  isLatestVersion: boolean('is_latest_version').notNull().default(true),
  uploadedById: uuid('uploaded_by_id')
    .references(() => users.id)
    .notNull(),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Tasks Table
export const tasks = pgTable('tasks', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenderId: uuid('tender_id')
    .references(() => tenders.id)
    .notNull(),
  title: varchar('title', { length: 255 }).notNull(),
  description: text('description'),
  assignedToId: uuid('assigned_to_id').references(() => users.id),
  dueDate: timestamp('due_date', { withTimezone: true }),
  isCompleted: boolean('is_completed').notNull().default(false),
  completedAt: timestamp('completed_at', { withTimezone: true }),
  priority: integer('priority').notNull().default(0), // 0=Low, 1=Medium, 2=High
  createdById: uuid('created_by_id')
    .references(() => users.id)
    .notNull(),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Notifications Table
export const notifications = pgTable('notifications', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id')
    .references(() => users.id)
    .notNull(),
  type: notificationTypeEnum('type').notNull(),
  title: varchar('title', { length: 255 }).notNull(),
  message: text('message').notNull(),
  relatedEntityId: uuid('related_entity_id'), // Could be tender_id, task_id, etc.
  isRead: boolean('is_read').notNull().default(false),
  readAt: timestamp('read_at', { withTimezone: true }),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Activity Logs Table
export const activityLogs = pgTable('activity_logs', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenderId: uuid('tender_id').references(() => tenders.id),
  userId: uuid('user_id')
    .references(() => users.id)
    .notNull(),
  action: varchar('action', { length: 100 }).notNull(),
  details: text('details'),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Custom Fields Table
export const customFields = pgTable('custom_fields', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: varchar('name', { length: 100 }).notNull(),
  fieldType: varchar('field_type', { length: 50 }).notNull(), // text, number, date, boolean, etc.
  isRequired: boolean('is_required').notNull().default(false),
  createdById: uuid('created_by_id')
    .references(() => users.id)
    .notNull(),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Custom Field Values Table
export const customFieldValues = pgTable('custom_field_values', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenderId: uuid('tender_id')
    .references(() => tenders.id)
    .notNull(),
  customFieldId: uuid('custom_field_id')
    .references(() => customFields.id)
    .notNull(),
  value: text('value'),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Team Members Table (Many-to-Many relationship between Users and Tenders)
export const tenderTeamMembers = pgTable('tender_team_members', {
  id: uuid('id').primaryKey().defaultRandom(),
  tenderId: uuid('tender_id')
    .references(() => tenders.id)
    .notNull(),
  userId: uuid('user_id')
    .references(() => users.id)
    .notNull(),
  role: varchar('role', { length: 100 }).notNull(), // e.g., "Lead", "Technical Reviewer", "Financial Analyst"
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});

// Define relations
export const usersRelations = relations(users, ({ many }) => ({
  createdTenders: many(tenders, { relationName: 'created_tenders' }),
  updatedTenders: many(tenders, { relationName: 'updated_tenders' }),
  assignedTasks: many(tasks, { relationName: 'assigned_tasks' }),
  createdTasks: many(tasks, { relationName: 'created_tasks' }),
  uploadedDocuments: many(documents, { relationName: 'uploaded_documents' }),
  notifications: many(notifications),
  activityLogs: many(activityLogs),
  createdCustomFields: many(customFields),
  teamMemberships: many(tenderTeamMembers),
  createdClients: many(clients),
}));

export const clientsRelations = relations(clients, ({ many, one }) => ({
  tenders: many(tenders),
  createdBy: one(users, {
    fields: [clients.createdById],
    references: [users.id],
  }),
}));

export const tendersRelations = relations(tenders, ({ many, one }) => ({
  client: one(clients, {
    fields: [tenders.clientId],
    references: [clients.id],
  }),
  createdBy: one(users, {
    fields: [tenders.createdById],
    references: [users.id],
    relationName: 'created_tenders',
  }),
  updatedBy: one(users, {
    fields: [tenders.updatedById],
    references: [users.id],
    relationName: 'updated_tenders',
  }),
  documents: many(documents),
  tasks: many(tasks),
  activityLogs: many(activityLogs),
  customFieldValues: many(customFieldValues),
  teamMembers: many(tenderTeamMembers),
}));

export const documentsRelations = relations(documents, ({ one }) => ({
  tender: one(tenders, {
    fields: [documents.tenderId],
    references: [tenders.id],
  }),
  uploadedBy: one(users, {
    fields: [documents.uploadedById],
    references: [users.id],
    relationName: 'uploaded_documents',
  }),
}));

export const tasksRelations = relations(tasks, ({ one }) => ({
  tender: one(tenders, {
    fields: [tasks.tenderId],
    references: [tenders.id],
  }),
  assignedTo: one(users, {
    fields: [tasks.assignedToId],
    references: [users.id],
    relationName: 'assigned_tasks',
  }),
  createdBy: one(users, {
    fields: [tasks.createdById],
    references: [users.id],
    relationName: 'created_tasks',
  }),
}));

export const notificationsRelations = relations(notifications, ({ one }) => ({
  user: one(users, {
    fields: [notifications.userId],
    references: [users.id],
  }),
}));

export const activityLogsRelations = relations(activityLogs, ({ one }) => ({
  tender: one(tenders, {
    fields: [activityLogs.tenderId],
    references: [tenders.id],
  }),
  user: one(users, {
    fields: [activityLogs.userId],
    references: [users.id],
  }),
}));

export const customFieldsRelations = relations(
  customFields,
  ({ many, one }) => ({
    values: many(customFieldValues),
    createdBy: one(users, {
      fields: [customFields.createdById],
      references: [users.id],
    }),
  })
);

export const customFieldValuesRelations = relations(
  customFieldValues,
  ({ one }) => ({
    tender: one(tenders, {
      fields: [customFieldValues.tenderId],
      references: [tenders.id],
    }),
    customField: one(customFields, {
      fields: [customFieldValues.customFieldId],
      references: [customFields.id],
    }),
  })
);

export const tenderTeamMembersRelations = relations(
  tenderTeamMembers,
  ({ one }) => ({
    tender: one(tenders, {
      fields: [tenderTeamMembers.tenderId],
      references: [tenders.id],
    }),
    user: one(users, {
      fields: [tenderTeamMembers.userId],
      references: [users.id],
    }),
  })
);
```
