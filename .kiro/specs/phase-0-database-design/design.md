# Phase 0: Database Design - Foundation Schema Design

## Overview

The Database Design establishes the foundational data architecture for Tender Track 360, integrating Better Auth with organization-based multi-tenancy and creating optimized schemas for efficient tender management. The design focuses on data integrity, performance, and scalability while supporting the complete tender lifecycle.

## Architecture

### Database Architecture

- **Authentication Layer**: Better Auth auto-generated tables with Drizzle integration
- **Organization Layer**: Multi-tenant architecture with organization-based data isolation
- **Core Business Layer**: Tender, client, and category management tables
- **Document Layer**: UploadThing integration with metadata storage
- **Audit Layer**: Comprehensive change tracking and activity logging
- **Performance Layer**: Optimized indexes and query patterns

### Multi-Tenancy Strategy

- **Organization-based Isolation**: All business data scoped to organizations
- **Row-Level Security**: Database-level enforcement of organization boundaries
- **Shared Schema**: Single database with organization_id filtering
- **Better Auth Integration**: User authentication with organization assignment

## Database Schema Design

### Better Auth Integration

Better Auth will auto-generate these tables:

```sql
-- Auto-generated by Better Auth
user (id, email, emailVerified, name, createdAt, updatedAt)
session (id, userId, expiresAt, token, createdAt, updatedAt)
account (id, userId, accountId, providerId, accessToken, refreshToken, ...)
verification (id, identifier, value, expiresAt, createdAt, updatedAt)
```

### Core Business Tables

#### Organizations Table

```typescript
export const organizations = pgTable('organizations', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: varchar('name', { length: 255 }).notNull(),
  slug: varchar('slug', { length: 100 }).notNull().unique(),
  description: text('description'),
  website: varchar('website', { length: 255 }),
  contactEmail: varchar('contact_email', { length: 255 }),
  contactPhone: varchar('contact_phone', { length: 50 }),
  address: text('address'),
  isActive: boolean('is_active').notNull().default(true),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});
```

#### Enhanced Users Table

```typescript
export const users = pgTable('users', {
  id: uuid('id').primaryKey().notNull(),
  organizationId: uuid('organization_id')
    .references(() => organizations.id)
    .notNull(),
  email: varchar('email', { length: 255 }).notNull().unique(),
  fullName: varchar('full_name', { length: 255 }),
  role: userRoleEnum('role').notNull().default('viewer'),
  department: varchar('department', { length: 100 }),
  isActive: boolean('is_active').notNull().default(true),
  lastLogin: timestamp('last_login', { withTimezone: true }),
  profileImageUrl: varchar('profile_image_url', { length: 255 }),
  onboardingCompleted: boolean('onboarding_completed').notNull().default(false),
  isDeleted: boolean('is_deleted').notNull().default(false),
  deletedAt: timestamp('deleted_at', { withTimezone: true }),
  deletedById: uuid('deleted_by_id'),
  createdAt: timestamp('created_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .notNull()
    .defaultNow(),
});
```

#### Enhanced Tenders Table

```typescript
export const tenders = pgTable(
  'tenders',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    organizationId: uuid('organization_id')
      .references(() => organizations.id)
      .notNull(),
    referenceNumber: varchar('reference_number', { length: 100 }).notNull(),
    title: varchar('title', { length: 255 }).notNull(),
    description: text('description'),
    clientId: uuid('client_id')
      .references(() => clients.id)
      .notNull(),
    categoryId: uuid('category_id').references(() => tenderCategories.id),
    status: tenderStatusEnum('status').notNull().default('in_progress'),
    closingDate: timestamp('closing_date', { withTimezone: true }),
    evaluationDate: date('evaluation_date'), // Auto-calculated: closingDate + 90 days
    awardDate: date('award_date'), // Only set when awarded
    estimatedValue: numeric('estimated_value', { precision: 15, scale: 2 }),
    actualValue: numeric('actual_value', { precision: 15, scale: 2 }),
    isSuccessful: boolean('is_successful'),
    department: varchar('department', { length: 100 }),
    notes: text('notes'),
    tags: text('tags').array(), // PostgreSQL array for tags
    isDeleted: boolean('is_deleted').notNull().default(false),
    deletedAt: timestamp('deleted_at', { withTimezone: true }),
    deletedById: uuid('deleted_by_id'),
    createdById: uuid('created_by_id')
      .references(() => users.id)
      .notNull(),
    updatedById: uuid('updated_by_id')
      .references(() => users.id)
      .notNull(),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (table) => ({
    // Composite unique constraint for reference number within organization
    orgReferenceIdx: uniqueIndex('idx_tenders_org_reference').on(
      table.organizationId,
      table.referenceNumber
    ),
    statusClosingIdx: index('idx_tenders_status_closing').on(
      table.status,
      table.closingDate
    ),
    clientIdx: index('idx_tenders_client').on(table.clientId),
    categoryIdx: index('idx_tenders_category').on(table.categoryId),
    createdByIdx: index('idx_tenders_created_by').on(table.createdById),
    organizationIdx: index('idx_tenders_organization').on(table.organizationId),
  })
);
```

#### Enhanced Clients Table

```typescript
export const clients = pgTable(
  'clients',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    organizationId: uuid('organization_id')
      .references(() => organizations.id)
      .notNull(),
    name: varchar('name', { length: 255 }).notNull(),
    type: clientTypeEnum('type').notNull(),
    contactPerson: varchar('contact_person', { length: 255 }),
    contactEmail: varchar('contact_email', { length: 255 }),
    contactPhone: varchar('contact_phone', { length: 50 }),
    address: text('address'),
    website: varchar('website', { length: 255 }),
    description: text('description'),
    isActive: boolean('is_active').notNull().default(true),
    isDeleted: boolean('is_deleted').notNull().default(false),
    deletedAt: timestamp('deleted_at', { withTimezone: true }),
    deletedById: uuid('deleted_by_id'),
    createdById: uuid('created_by_id').references(() => users.id),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (table) => ({
    organizationIdx: index('idx_clients_organization').on(table.organizationId),
    nameIdx: index('idx_clients_name').on(table.name),
  })
);
```

#### Enhanced Categories Table

```typescript
export const tenderCategories = pgTable(
  'tender_categories',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    organizationId: uuid('organization_id').references(() => organizations.id), // null for system defaults
    name: varchar('name', { length: 100 }).notNull(),
    description: text('description'),
    isActive: boolean('is_active').notNull().default(true),
    isSystemDefault: boolean('is_system_default').notNull().default(false),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (table) => ({
    organizationIdx: index('idx_categories_organization').on(
      table.organizationId
    ),
    systemDefaultIdx: index('idx_categories_system').on(table.isSystemDefault),
  })
);
```

### Audit and Tracking Tables

#### Status Transitions Table

```typescript
export const statusTransitions = pgTable(
  'status_transitions',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    tenderId: uuid('tender_id')
      .references(() => tenders.id)
      .notNull(),
    fromStatus: tenderStatusEnum('from_status'),
    toStatus: tenderStatusEnum('to_status').notNull(),
    userId: uuid('user_id')
      .references(() => users.id)
      .notNull(),
    notes: text('notes'),
    isSystemGenerated: boolean('is_system_generated').notNull().default(false),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (table) => ({
    tenderIdx: index('idx_status_transitions_tender').on(
      table.tenderId,
      table.createdAt
    ),
    userIdx: index('idx_status_transitions_user').on(table.userId),
  })
);
```

#### Enhanced Activity Logs Table

```typescript
export const activityLogs = pgTable(
  'activity_logs',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    organizationId: uuid('organization_id')
      .references(() => organizations.id)
      .notNull(),
    tenderId: uuid('tender_id').references(() => tenders.id),
    userId: uuid('user_id')
      .references(() => users.id)
      .notNull(),
    action: varchar('action', { length: 100 }).notNull(),
    entityType: varchar('entity_type', { length: 50 }).notNull(), // 'tender', 'document', 'task', etc.
    entityId: uuid('entity_id'),
    oldValues: jsonb('old_values'), // Store previous values for comparison
    newValues: jsonb('new_values'), // Store new values
    details: text('details'),
    ipAddress: varchar('ip_address', { length: 45 }),
    userAgent: text('user_agent'),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (table) => ({
    organizationIdx: index('idx_activity_logs_organization').on(
      table.organizationId,
      table.createdAt
    ),
    tenderIdx: index('idx_activity_logs_tender').on(
      table.tenderId,
      table.createdAt
    ),
    userIdx: index('idx_activity_logs_user').on(table.userId, table.createdAt),
    actionIdx: index('idx_activity_logs_action').on(table.action),
    entityIdx: index('idx_activity_logs_entity').on(
      table.entityType,
      table.entityId
    ),
  })
);
```

### Document Management Tables

#### Enhanced Documents Table

```typescript
export const documents = pgTable(
  'documents',
  {
    id: uuid('id').primaryKey().defaultRandom(),
    organizationId: uuid('organization_id')
      .references(() => organizations.id)
      .notNull(),
    tenderId: uuid('tender_id')
      .references(() => tenders.id)
      .notNull(),
    parentDocumentId: uuid('parent_document_id'), // For versioning
    category: documentCategoryEnum('category').notNull(),
    title: varchar('title', { length: 255 }).notNull(),
    fileName: varchar('file_name', { length: 255 }).notNull(),
    fileSize: integer('file_size').notNull(),
    mimeType: varchar('mime_type', { length: 100 }).notNull(),
    uploadThingUrl: varchar('uploadthing_url', { length: 500 }).notNull(),
    uploadThingKey: varchar('uploadthing_key', { length: 255 }).notNull(),
    checksumHash: varchar('checksum_hash', { length: 64 }),
    version: integer('version').notNull().default(1),
    isLatestVersion: boolean('is_latest_version').notNull().default(true),
    tags: text('tags').array(),
    description: text('description'),
    isArchived: boolean('is_archived').notNull().default(false),
    archiveReason: varchar('archive_reason', { length: 255 }),
    isDeleted: boolean('is_deleted').notNull().default(false),
    deletedAt: timestamp('deleted_at', { withTimezone: true }),
    deletedById: uuid('deleted_by_id'),
    uploadedById: uuid('uploaded_by_id')
      .references(() => users.id)
      .notNull(),
    createdAt: timestamp('created_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true })
      .notNull()
      .defaultNow(),
  },
  (table) => ({
    organizationIdx: index('idx_documents_organization').on(
      table.organizationId
    ),
    tenderCategoryIdx: index('idx_documents_tender_category').on(
      table.tenderId,
      table.category
    ),
    versionIdx: index('idx_documents_version').on(
      table.parentDocumentId,
      table.version
    ),
    uploadedByIdx: index('idx_documents_uploaded_by').on(table.uploadedById),
    uploadThingKeyIdx: uniqueIndex('idx_documents_uploadthing_key').on(
      table.uploadThingKey
    ),
  })
);
```

## Data Relationships

### Primary Relationships

- Organizations → Users (1:many)
- Organizations → Tenders (1:many)
- Organizations → Clients (1:many)
- Tenders → Documents (1:many)
- Tenders → Status Transitions (1:many)
- Users → Activity Logs (1:many)

### Referential Integrity

- All foreign keys with proper constraints
- Cascade deletes for dependent data
- Soft deletes for audit trail preservation
- Organization-level data isolation

## Performance Optimizations

### Indexing Strategy

- Composite indexes for common query patterns
- Organization-based indexes for multi-tenancy
- Time-based indexes for audit queries
- Unique constraints for business rules

### Query Optimization

- Efficient pagination with cursor-based pagination
- Optimized joins for related data fetching
- Materialized views for complex aggregations
- Connection pooling for concurrent access

## Security Considerations

### Data Isolation

- Organization-based row-level security
- User role-based access control
- Audit trail for all data access
- Encrypted sensitive fields

### Compliance

- GDPR-compliant data retention
- Audit trail immutability
- Data export capabilities
- Secure data deletion
